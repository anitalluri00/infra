pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
    ansiColor('xterm')
  }

  parameters {
    choice(name: 'ENVIRONMENT', choices: ['prod', 'dr'], description: 'Target environment')
    string(name: 'IMAGE_TAG', defaultValue: '', description: 'Optional image tag override')
  }

  environment {
    AWS_REGION    = 'us-east-1'
    AWS_ACCOUNT   = '123456789012'
    ECR_REGISTRY  = "${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    BACKEND_REPO  = 'mis/backend'
    FRONTEND_REPO = 'mis/frontend'
    DEPLOY_TAG    = "${params.IMAGE_TAG ?: env.BUILD_NUMBER}"
    KUBE_NS       = 'mis-prod'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Images') {
      steps {
        sh '''
          set -euo pipefail
          docker build -t ${ECR_REGISTRY}/${BACKEND_REPO}:${DEPLOY_TAG} -f backend/Dockerfile .
          docker build -t ${ECR_REGISTRY}/${FRONTEND_REPO}:${DEPLOY_TAG} -f frontend/Dockerfile .
        '''
      }
    }

    stage('Security Scan') {
      steps {
        sh '''
          set -euo pipefail
          ./cicd/scripts/container_scan.sh \
            ${ECR_REGISTRY}/${BACKEND_REPO}:${DEPLOY_TAG} \
            ${ECR_REGISTRY}/${FRONTEND_REPO}:${DEPLOY_TAG}
        '''
      }
    }

    stage('Push Images') {
      steps {
        sh '''
          set -euo pipefail
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
          docker push ${ECR_REGISTRY}/${BACKEND_REPO}:${DEPLOY_TAG}
          docker push ${ECR_REGISTRY}/${FRONTEND_REPO}:${DEPLOY_TAG}
        '''
      }
    }

    stage('Deploy Preview') {
      steps {
        sh '''
          set -euo pipefail
          aws eks update-kubeconfig --region ${AWS_REGION} --name mis-prod-eks
          ./cicd/scripts/blue_green_deploy.sh preview ${KUBE_NS} ${DEPLOY_TAG}
        '''
      }
    }

    stage('Smoke Test') {
      steps {
        sh '''
          set -euo pipefail
          curl --fail --silent --show-error --max-time 30 https://preview.portal.example.gov/health
        '''
      }
    }

    stage('Approval') {
      steps {
        input message: "Promote build ${DEPLOY_TAG} to active production?", ok: 'Promote'
      }
    }

    stage('Promote') {
      steps {
        sh '''
          set -euo pipefail
          ./cicd/scripts/blue_green_deploy.sh promote ${KUBE_NS} ${DEPLOY_TAG}
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'scan-reports/*.txt', allowEmptyArchive: true
    }
    failure {
      mail to: 'sre-team@example.gov',
           subject: "MIS pipeline failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
           body: "Check Jenkins logs for details"
    }
  }
}
